<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirmar - InvestSmart</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: black;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      font-size: 16px;
      display: none;
    }

    .show {
      display: block;
    }

    .toast-error {
      background-color: #dc3545;
    }

    /* Estilo para o cartão */
    .card {
      display: flex;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      background-color: white;
      overflow: hidden;
      padding: 20px;
      margin-top: 20px;
    }

    .card img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
    }

    .card-content {
      margin-left: 20px;
      flex: 1;
    }

    .card-content h2 {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }

    .card-content p {
      font-size: 18px;
      margin: 10px 0;
    }

    .card-content .price {
      font-size: 20px;
      font-weight: bold;
      color: #e74c3c;
    }

    .card-content .confirm-btn {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .card-content .confirm-btn:hover {
      background-color: #2980b9;
    }
    
    .countdown {
      font-size: 16px;
      font-weight: bold;
      color: #e74c3c;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- HEADER -->
  <header class="bg-black text-white py-4 sticky top-0 shadow-md z-50">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">InvestSmart</h1>
    </div>
  </header>

  <!-- Conteúdo Principal -->
  <section class="py-10">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Cartão de confirmação -->
      <div class="card">
        <!-- Imagem do produto (ou investimento) -->
        <img src="https://images.unsplash.com/photo-1596687760372-4c0d266059a7?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTh8fG1vdG98ZW58MHx8MHx8fDA%3D" alt="Plano VIP1" class="rounded-md mb-4 w-full h-28 object-cover" alt="Imagem do Plano de Investimento" />
        
        <!-- Conteúdo do cartão -->
        <div class="card-content">
          <h2>vip6</h2>
          <p><strong>Preço:</strong> 130,000 KZS</p>
          <p><strong>Renda diária:</strong> 14,300.00 KZS</p>
          <p><strong>Renda total:</strong> 1,072,500.00 KZS</p>
          <p><strong>Prazo:</strong> 75 dias</p>

          <p><strong>Limite de exemplares:</strong> <span id="dataCompra"></span></p>
          <p><strong>100, EXEMPLARES:</strong> <span id="dataValidade"></span></p>

          <p id="countdown" class="countdown"></p>

          <button id="confirmButton" class="confirm-btn mt-4">Confirmar Compra</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast de sucesso/erro -->
  <div id="toast" class="toast">Compra efetuada com sucesso!</div>
  <div id="toastError" class="toast toast-error">Saldo insuficiente. Por favor, recarregue a sua conta.</div>

  <!-- RODAPÉ FIXO ESTILO APP -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-inner z-50 md:hidden">
    <div class="flex justify-around items-center py-2 text-gray-600">
      <a href="home.html" class="flex flex-col items-center text-sm hover:text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9l9-6 9 6v10.5A1.5 1.5 0 0 1 19.5 21h-15A1.5 1.5 0 0 1 3 19.5V9z" />
        </svg>
        Início
      </a>
      <a href="investir.html" class="flex flex-col items-center text-sm hover:text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8v1m0 7v1m-9-5a9 9 0 1 1 18 0 9 9 0 0 1-18 0z" />
        </svg>
        Investir
      </a>
      <a href="tarefas.html" class="flex flex-col items-center text-sm hover:text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7h18M3 11h18M3 15h18M3 19h18" />
        </svg>
        Equipe
      </a>
      <a href="perfil.html" class="flex flex-col items-center text-sm hover:text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6.75a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0zM4.5 20.25a8.25 8.25 0 0 1 15 0" />
        </svg>
        Perfil
      </a>
    </div>
  </nav>

  <script>
    // Função para calcular a contagem regressiva
    function iniciarContagemRegressiva(dataValidade) {
      const countdownElement = document.getElementById('countdown');
      const validadeDate = new Date(dataValidade).getTime();

      setInterval(function () {
        const agora = new Date().getTime();
        const distancia = validadeDate - agora;

        if (distancia < 0) {
          countdownElement.innerHTML = "O prazo expirou!";
        } else {
          const dias = Math.floor(distancia / (1000 * 60 * 60 * 24));
          const horas = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutos = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
          const segundos = Math.floor((distancia % (1000 * 60)) / 1000);

          countdownElement.innerHTML = `${dias}d ${horas}h ${minutos}m ${segundos}s`;
        }
      }, 1000);
    }

    // Função para mostrar a data da compra e a data de validade
    function mostrarDatasCompra() {
      const dataCompra = new Date().toLocaleString();
      const dataValidade = new Date();
      dataValidade.setDate(dataValidade.getDate() + 75); // 75 dias a partir de hoje

      // Atualizando as datas no HTML
      document.getElementById('dataCompra').textContent = dataCompra;
      document.getElementById('dataValidade').textContent = dataValidade.toLocaleString();

      // Iniciar a contagem regressiva
      iniciarContagemRegressiva(dataValidade);
    }

   // Função para mostrar o toast
function showToast(message, isError = false) {
  const toast = document.createElement('div');
  toast.className = `toast ${isError ? 'toast-error' : ''}`;
  toast.textContent = message;

  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);

  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => document.body.removeChild(toast), 500);
  }, 3000);

  // Adicionar redirecionamento após 3 segundos
  if (!isError) {
    setTimeout(() => {
      window.location.href = 'produtos.html';  // Redireciona para a página de produtos
    }, 3000);  // Espera 3 segundos (tempo do toast)
  }
}

    document.getElementById('confirmButton').addEventListener('click', async function () {
      const userId = localStorage.getItem('user_id');
      if (!userId) {
        showToast('Usuário não encontrado', true);
        return;
      }
  
      const preco = 130000;
  
      try {
        // 1. Buscar saldo atualizado do backend
        const userData = await carregarDadosUsuario();
        if (!userData) return;
  
        if (userData.saldo < preco) {
          showToast('Saldo insuficiente. Por favor, recarregue sua conta.', true);
          return;
        }
  
        // 2. Deduzir saldo localmente e enviar para o backend
        const novoSaldo = userData.saldo - preco;
  
        // 3. Atualizar o saldo no backend
        const atualizarResponse = await fetch(`https://meuappi.onrender.com/usuarios/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ saldo: novoSaldo })
        });
  
        if (!atualizarResponse.ok) throw new Error('Erro ao atualizar saldo do usuário');
  
        // 4. Registrar a compra
const dataCompra = new Date().toISOString(); // ou .toLocaleString() se preferir

const compraResponse = await fetch('https://meuappi.onrender.com/produtos', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: userId,
    produto: 'vip6',
    preco: preco,
    renda_diaria: 14300,
    renda_total: 1072500,
    prazo: 75,
    dataCompra: dataCompra // <-- Aqui está a data sendo enviada
  })
});

  
        if (!compraResponse.ok) throw new Error('Erro ao registrar compra');
  
        showToast('Compra efetuada com sucesso!');
        await carregarDadosUsuario(); // Atualiza localStorage com novo saldo
        mostrarDatasCompra(); // Mostrar datas após a compra
      } catch (error) {
        console.error('Erro na compra:', error);
        showToast('Erro ao realizar compra. Tente novamente.', true);
      }
    });

    // Função que carrega os dados do usuário logado
    async function carregarDadosUsuario() {
      const userId = localStorage.getItem('user_id');
      if (!userId) {
        showToast('Usuário não autenticado.', true);
        return;
      }
  
      try {
        const response = await fetch(`https://meuappi.onrender.com/usuarios/${userId}`);
        if (!response.ok) throw new Error('Erro ao buscar usuário');
  
        const dados = await response.json();
        localStorage.setItem('user_data', JSON.stringify(dados));
        return dados;
      } catch (erro) {
        console.error(erro);
        showToast('Erro ao carregar dados do usuário', true);
        return null;
      }
    }

    // Carregar dados do usuário ao iniciar a página
    window.onload = carregarDadosUsuario;
  </script>
</body>

</html>
